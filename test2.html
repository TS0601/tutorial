<!DOCTYPE html>
<html>
  <head>
    <title>test2</title>
    <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase-firestore.js"></script>

    <!-- FirebaseUI を追加 -->

    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />

<script>

    firebase.initializeApp({
      apiKey: "AIzaSyBgmke1S6n1nKQZ0Ez6kJ85o3PEOklyKbI",
      authDomain: "qualification-master.firebaseapp.com",
      databaseURL: "https://qualification-master.firebaseio.com",
      projectId: "qualification-master",
      storageBucket: "qualification-master.appspot.com",
      messagingSenderId: "733843168310",
      appId: "1:733843168310:web:1aa23bde7d4373dd"
    });
    
    // Initialize Cloud Firestore through Firebase
    var db = firebase.firestore();

var usersRef = db.collection("users");

//日付取得

myTbl     = new Array("日","月","火","水","木","金","土");
  myD       = new Date();
  myYear    = myD.getYear()
  myYear4   = (myYear < 2000) ? myYear+1900 : myYear;
  myMonth   = myD.getMonth() + 1;
  myDate    = myD.getDate();
  myDay     = myD.getDay();
  myHours   = myD.getHours();
  myMinutes = myD.getMinutes();
  mySeconds = myD.getSeconds();

  myMess1   = myYear4 + "年" + myMonth + "月" + myDate + "日";
  myMess2   = myTbl[myDay] + "曜日";
  myMess3   = myHours + "時" + myMinutes + "分" + mySeconds + "秒";
  myMess    = myMess1 + " " + myMess2 + " " + myMess3;

// URL文字列からページ文字列を取得する
var getPageStr = function(url) {
    // URL文字列を「/」区切りで分解
    var arg = url.split("/");
    // 末尾の要素を取り出し
    var ret = arg.slice(-1)[0];
    // 末尾が空の場合は更に一つ前の要素を取り出し
    if(ret === "" && arg.length > 1) {
        ret = arg.slice(-2)[0];
    }
    // ?, #, &より前の要素のみを取り出し
    ret = ret.split("?")[0];
    ret = ret.split("#")[0];
    ret = ret.split("&")[0];
	return ret;
};

//データ読み込み用の関数

var docRef = db.collection("users").doc("TESTUSER");

var lastanswer = {};

docRef.get().then(function(doc) {
    if (doc.exists) {
        var j = calcAnswer("test.html",doc) ;
        document.getElementById("ratej").innerHTML = j; 
        var k = calcAnswer("test3.html",doc) ;
        document.getElementById("ratek").innerHTML = k; 
    } else {
        // doc.data() will be undefined in this case
        console.log("No such document!");
    }
}).catch(function(error) {
    console.log("Error getting document:", error);
});

function calcAnswer(URLkey,doc) {
  lastanswer = doc.data().sendArray[URLkey];
  var j = 0;
  for(i=0;i<100;i++){
      if(lastanswer && lastanswer.hasOwnProperty("q"+i) && lastanswer["q"+i] == true){
          j ++;
      }
  }
  return j;
}

</script>

 </head>
  <body>

<p>正答数：<span id="ratej"></span>/3</p>

<p>正答数：<span id="ratek"></span>/4</p>
-----------
<script>

//データの定義

var send = function(question_id,judge){

  var sample = {
    学習日:new Date(),
    学習進捗:true,
};
sample["q"+question_id] = judge;
//var answers = [];

//q1 = {};
//q1["q"+question_id] = judge;
//answers.push(q1);

//sample["answers"] = answers;

//データの送信
var url = getPageStr(location.pathname);
var sendArray = {};
sendArray[url] = sample;
usersRef.doc("TESTUSER").set(
  {sendArray},

//データが書けたかどうかの判定

{merge: true})
.then(function() {
console.log("Document successfully written!");
})
.catch(function(error) {
console.error("Error writing document: ", error);
});

}

</script>

  </body>
</html>